<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cake Editor</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="p-6 max-w-3xl mx-auto bg-white text-gray-800">
  <h1 id="cakeTitle" class="text-2xl font-bold mb-6"></h1>

  <!-- üßÅ INGREDIENTS SECTION -->
  <h2 class="text-xl font-semibold mb-4">Ingredients</h2>
  <div class="mb-8 space-y-2">
    <input id="ingredientName" type="text" placeholder="Ingredient Name" class="border p-2 w-full rounded">
    <input id="ingredientCost" type="number" step="0.01" placeholder="Cost per Unit ($)" class="border p-2 w-full rounded">
    <input id="ingredientUnit" type="text" placeholder="Unit (e.g. 100g, egg)" class="border p-2 w-full rounded">
    <button onclick="addIngredient()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Add Ingredient</button>
  </div>

  <table class="w-full border-collapse text-sm mb-8">
    <thead class="bg-gray-100">
      <tr>
        <th class="border p-2 text-left">Ingredient</th>
        <th class="border p-2 text-left">Cost / Unit</th>
        <th class="border p-2 text-left">Unit</th>
        <th class="border p-2 text-right">Actions</th>
      </tr>
    </thead>
    <tbody id="ingredientTableBody"></tbody>
  </table>

  <!-- üç∞ RECIPE SECTION -->
  <h2 class="text-xl font-semibold mb-4">Recipe</h2>
  <div class="mb-8 flex space-x-2">
    <select id="recipeIngredient" class="border p-2 rounded w-1/2"></select>
    <input id="recipeQuantity" type="number" step="0.01" placeholder="Quantity" class="border p-2 rounded w-1/3">
    <button onclick="addToRecipe()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Add to Recipe</button>
  </div>

  <table class="w-full border-collapse text-sm">
    <thead class="bg-gray-100">
      <tr>
        <th class="border p-2 text-left">Ingredient</th>
        <th class="border p-2 text-left">Quantity</th>
        <th class="border p-2 text-right">Cost</th>
        <th class="border p-2 text-right">Actions</th>
      </tr>
    </thead>
    <tbody id="recipeTableBody"></tbody>
  </table>

  <h3 class="text-lg font-semibold mt-4">Total Cost: $<span id="totalCost">0.00</span></h3>

  <div class="mt-8 flex justify-between">
    <button onclick="saveAndReturn()" class="bg-gray-700 text-white px-4 py-2 rounded hover:bg-gray-800">Save & Return</button>
    <button onclick="goBack()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Cancel</button>
  </div>

  <!-- ‚úèÔ∏è EDIT INGREDIENT MODAL -->
  <div id="editModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-6 rounded-lg w-96 shadow-lg">
      <h2 class="text-xl font-semibold mb-4">Edit Ingredient</h2>
      <div class="space-y-2">
        <input id="editName" type="text" class="border p-2 w-full rounded" placeholder="Ingredient Name">
        <input id="editCost" type="number" step="0.01" class="border p-2 w-full rounded" placeholder="Cost per Unit ($)">
        <input id="editUnit" type="text" class="border p-2 w-full rounded" placeholder="Unit (e.g. 100g, egg)">
      </div>
      <div class="mt-4 flex justify-end space-x-2">
        <button onclick="closeEditModal()" class="bg-gray-400 text-white px-4 py-2 rounded hover:bg-gray-500">Cancel</button>
        <button onclick="saveEditedIngredient()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Save</button>
      </div>
    </div>
  </div>

  <!-- üí° SCRIPT -->
  <script>
    let cakes = JSON.parse(localStorage.getItem('cakes')) || [];
    const params = new URLSearchParams(window.location.search);
    const cakeIndex = parseInt(params.get('cake'), 10);
    if (isNaN(cakeIndex) || !cakes[cakeIndex]) {
      alert('Cake not found!');
      window.location.href = 'index.html';
    }

    let currentCake = cakes[cakeIndex];
    document.getElementById('cakeTitle').textContent = currentCake.name;

    function goBack() {
      window.location.href = 'index.html';
    }

    function saveCake() {
      cakes[cakeIndex] = currentCake;
      localStorage.setItem('cakes', JSON.stringify(cakes));
    }

    // üßÅ INGREDIENT MANAGEMENT
    function addIngredient() {
      const name = document.getElementById('ingredientName').value.trim();
      const cost = parseFloat(document.getElementById('ingredientCost').value);
      const unit = document.getElementById('ingredientUnit').value.trim();
      if (!name || isNaN(cost) || !unit) return alert('Please fill all fields.');

      currentCake.ingredients.push({ name, cost, unit });
      saveCake();
      updateIngredientTable();
      updateIngredientDropdown();

      document.getElementById('ingredientName').value = '';
      document.getElementById('ingredientCost').value = '';
      document.getElementById('ingredientUnit').value = '';
    }

    function updateIngredientTable() {
      const tbody = document.getElementById('ingredientTableBody');
      tbody.innerHTML = currentCake.ingredients.map((i, index) => `
        <tr>
          <td class="border p-2">${i.name}</td>
          <td class="border p-2">$${i.cost.toFixed(2)}</td>
          <td class="border p-2">${i.unit}</td>
          <td class="border p-2 text-right space-x-2">
            <button onclick="openEditModal(${index})" class="text-blue-600 hover:text-blue-800">‚úèÔ∏è</button>
            <button onclick="removeIngredient(${index})" class="text-red-500 hover:text-red-700">üóëÔ∏è</button>
          </td>
        </tr>
      `).join('');
    }

    function removeIngredient(index) {
      if (confirm(`Delete ingredient "${currentCake.ingredients[index].name}"?`)) {
        currentCake.ingredients.splice(index, 1);
        saveCake();
        updateIngredientTable();
        updateIngredientDropdown();
      }
    }

    // ‚úèÔ∏è EDIT MODAL LOGIC
    let editingIndex = null;

    function openEditModal(index) {
      editingIndex = index;
      const ingredient = currentCake.ingredients[index];
      document.getElementById('editName').value = ingredient.name;
      document.getElementById('editCost').value = ingredient.cost;
      document.getElementById('editUnit').value = ingredient.unit;
      document.getElementById('editModal').classList.remove('hidden');
    }

    function closeEditModal() {
      document.getElementById('editModal').classList.add('hidden');
    }

    function saveEditedIngredient() {
      const name = document.getElementById('editName').value.trim();
      const cost = parseFloat(document.getElementById('editCost').value);
      const unit = document.getElementById('editUnit').value.trim();
      if (!name || isNaN(cost) || !unit) return alert('Please fill all fields.');

      currentCake.ingredients[editingIndex] = { name, cost, unit };
      saveCake();
      updateIngredientTable();
      updateIngredientDropdown();
      closeEditModal();
    }

    // üç∞ RECIPE MANAGEMENT
    function updateIngredientDropdown() {
      const dropdown = document.getElementById('recipeIngredient');
      dropdown.innerHTML = currentCake.ingredients.map(i => `<option>${i.name}</option>`).join('');
    }

    function addToRecipe() {
      const name = document.getElementById('recipeIngredient').value;
      const qty = parseFloat(document.getElementById('recipeQuantity').value);
      if (!name || isNaN(qty) || qty <= 0) return alert('Enter valid quantity.');

      const ingredient = currentCake.ingredients.find(i => i.name === name);
      if (!ingredient) return;

      const cost = ingredient.cost * qty;
      currentCake.recipe.push({ name, qty, cost });
      saveCake();
      renderRecipeTable();

      document.getElementById('recipeQuantity').value = '';
    }

    function renderRecipeTable() {
      const tbody = document.getElementById('recipeTableBody');
      tbody.innerHTML = currentCake.recipe.map((r, index) => {
        const ingredient = currentCake.ingredients.find(i => i.name === r.name);
        const unit = ingredient ? ingredient.unit : '';
        return `
          <tr>
            <td class="border p-2">${r.name}</td>
            <td class="border p-2">${r.qty} √ó ${unit}</td>
            <td class="border p-2 text-right">$${r.cost.toFixed(2)}</td>
            <td class="border p-2 text-right">
              <button onclick="removeRecipeItem(${index})" class="text-red-500 hover:text-red-700">üóëÔ∏è</button>
            </td>
          </tr>
        `;
      }).join('');
      updateTotalCost();
    }

    function removeRecipeItem(index) {
      if (confirm(`Remove "${currentCake.recipe[index].name}" from recipe?`)) {
        currentCake.recipe.splice(index, 1);
        saveCake();
        renderRecipeTable();
      }
    }

    function updateTotalCost() {
      const total = currentCake.recipe.reduce((sum, i) => sum + i.cost, 0);
      document.getElementById('totalCost').textContent = total.toFixed(2);
    }

    function saveAndReturn() {
      saveCake();
      window.location.href = 'index.html';
    }

    window.addEventListener('DOMContentLoaded', () => {
      updateIngredientTable();
      updateIngredientDropdown();
      renderRecipeTable();
    });
  </script>
</body>
</html>
