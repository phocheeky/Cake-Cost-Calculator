<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cake Editor</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-orange-50 text-gray-800 min-h-screen flex flex-col items-center py-10 px-4">

  <div class="w-full max-w-xl bg-white shadow-md rounded-2xl p-6">
    <div class="flex justify-between items-center mb-4">
      <h1 id="cakeTitle" class="text-2xl font-bold text-orange-600">Cake Editor</h1>
      <button onclick="goBack()" class="bg-gray-200 px-3 py-1 rounded hover:bg-gray-300">‚¨Ö Back</button>
    </div>

    <!-- Ingredient Section -->
    <div class="mb-8">
      <h2 class="text-lg font-semibold mb-3">Add Ingredient</h2>
      <input id="ingredientName" placeholder="Ingredient name" class="border rounded-lg w-full p-2 mb-2" />
      <input id="ingredientCost" type="number" step="0.01" placeholder="Cost per unit ($)" class="border rounded-lg w-full p-2 mb-2" />
      <input id="ingredientUnit" placeholder="Unit (e.g. 100g, egg)" class="border rounded-lg w-full p-2 mb-2" />
      <button onclick="addIngredient()" class="w-full bg-orange-500 text-white py-2 rounded-lg hover:bg-orange-600 transition">Add Ingredient</button>
    </div>

    <!-- Recipe Section -->
    <div>
      <h2 class="text-lg font-semibold mb-3">Recipe</h2>
      <select id="recipeIngredient" class="border rounded-lg w-full p-2 mb-2"></select>
      <input id="recipeQuantity" type="number" step="0.01" placeholder="Quantity used" class="border rounded-lg w-full p-2 mb-2" />
      <button onclick="addToRecipe()" class="w-full bg-green-500 text-white py-2 rounded-lg hover:bg-green-600 transition">Add to Recipe</button>

      <table class="w-full mt-6 border-collapse text-sm">
        <thead class="bg-gray-100">
          <tr>
            <th class="border p-2 text-left">Ingredient</th>
            <th class="border p-2 text-left">Quantity</th>
            <th class="border p-2 text-right">Cost</th>
            <th class="border p-2 text-center">Actions</th>
          </tr>
        </thead>
        <tbody id="recipeTableBody"></tbody>
      </table>

      <h3 class="text-right text-lg font-semibold mt-4">
        Total Cost: $<span id="totalCost">0.00</span>
      </h3>
    </div>

    <button onclick="saveAndReturn()" class="mt-8 w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600 transition">
      üíæ Save & Return
    </button>
  </div>

  <!-- Footer for version info -->
  <footer class="mt-6 text-center text-sm text-gray-500">
    Version: <span id="version-number">Loading...</span>
  </footer>

  <script>
    // üßæ Version fetcher (gracefully fallback)
    fetch('version.txt')
      .then(response => response.ok ? response.text() : Promise.reject())
      .then(data => {
        document.getElementById('version-number').textContent = data.trim();
      })
      .catch(() => {
        document.getElementById('version-number').textContent = '1.0.0';
      });

    // üç∞ Data setup
    let cakes = JSON.parse(localStorage.getItem('cakes')) || [];
    const params = new URLSearchParams(window.location.search);
    const cakeIndex = parseInt(params.get('cake'), 10);

    if (isNaN(cakeIndex) || !cakes[cakeIndex]) {
      alert('Cake not found!');
      window.location.href = 'index.html';
    }

    let currentCake = cakes[cakeIndex];
    if (!currentCake.ingredients) currentCake.ingredients = [];
    if (!currentCake.recipe) currentCake.recipe = [];

    document.getElementById('cakeTitle').textContent = currentCake.name;

    function goBack() {
      window.location.href = 'index.html';
    }

    function saveCake() {
      cakes[cakeIndex] = currentCake;
      localStorage.setItem('cakes', JSON.stringify(cakes));
    }

    // üßÅ INGREDIENT FUNCTIONS
    function addIngredient() {
      const name = document.getElementById('ingredientName').value.trim();
      const cost = parseFloat(document.getElementById('ingredientCost').value);
      const unit = document.getElementById('ingredientUnit').value.trim();
      if (!name || isNaN(cost) || !unit) return alert('Fill in all fields');

      if (currentCake.ingredients.some(i => i.name.toLowerCase() === name.toLowerCase())) {
        alert('Ingredient already exists.');
        return;
      }

      currentCake.ingredients.push({ name, cost, unit });
      saveCake();
      updateIngredientDropdown();
      renderIngredientTable();

      document.getElementById('ingredientName').value = '';
      document.getElementById('ingredientCost').value = '';
      document.getElementById('ingredientUnit').value = '';
    }

    function removeIngredient(index) {
      const ingredient = currentCake.ingredients[index];
      if (!confirm(`Delete ingredient "${ingredient.name}"? This will also remove it from the recipe.`)) return;

      currentCake.ingredients.splice(index, 1);
      currentCake.recipe = currentCake.recipe.filter(r => r.name !== ingredient.name);
      saveCake();

      updateIngredientDropdown();
      renderIngredientTable();
      renderRecipeTable();
    }

    function updateIngredientDropdown() {
      const dropdown = document.getElementById('recipeIngredient');
      dropdown.innerHTML = currentCake.ingredients.map(i => `<option>${i.name}</option>`).join('');
    }

    function renderIngredientTable() {
      let existing = document.getElementById('ingredientTableContainer');
      if (!existing) {
        const container = document.createElement('div');
        container.id = 'ingredientTableContainer';
        container.className = 'mt-6';
        container.innerHTML = `
          <h3 class="text-lg font-semibold mb-2">Ingredients List</h3>
          <table class="w-full border-collapse text-sm">
            <thead class="bg-gray-100">
              <tr>
                <th class="border p-2 text-left">Name</th>
                <th class="border p-2 text-left">Cost per Unit</th>
                <th class="border p-2 text-left">Unit</th>
                <th class="border p-2 text-center">Actions</th>
              </tr>
            </thead>
            <tbody id="ingredientTableBody"></tbody>
          </table>
        `;
        document.querySelector('.mb-8').appendChild(container);
      }

      const tbody = document.getElementById('ingredientTableBody');
      tbody.innerHTML = currentCake.ingredients.map((i, index) => `
        <tr>
          <td class="border p-2">${i.name}</td>
          <td class="border p-2">$${i.cost.toFixed(2)}</td>
          <td class="border p-2">${i.unit}</td>
          <td class="border p-2 text-center">
            <button onclick="removeIngredient(${index})" class="text-red-500 hover:text-red-700">üóëÔ∏è</button>
          </td>
        </tr>
      `).join('');
    }

    // üç∞ RECIPE FUNCTIONS
    function addToRecipe() {
      const name = document.getElementById('recipeIngredient').value;
      const qty = parseFloat(document.getElementById('recipeQuantity').value);
      if (!name || isNaN(qty) || qty <= 0) return alert('Enter valid quantity');

      const ingredient = currentCake.ingredients.find(i => i.name === name);
      if (!ingredient) return;

      // üßÆ Corrected cost formula
      const unitValue = parseFloat(ingredient.unit); // try to get numeric part
      let cost;
      if (!isNaN(unitValue) && unitValue > 0 && qty < unitValue) {
        cost = (qty / unitValue) * ingredient.cost;
      } else {
        cost = ingredient.cost * qty;
      }

      currentCake.recipe.push({ name, qty, cost });
      saveCake();
      renderRecipeTable();

      document.getElementById('recipeQuantity').value = '';
    }

    function removeRecipeItem(index) {
      if (confirm(`Remove "${currentCake.recipe[index].name}" from recipe?`)) {
        currentCake.recipe.splice(index, 1);
        saveCake();
        renderRecipeTable();
      }
    }

    function renderRecipeTable() {
      const tbody = document.getElementById('recipeTableBody');
      tbody.innerHTML = currentCake.recipe.map((r, index) => {
        const ingredient = currentCake.ingredients.find(i => i.name === r.name);
        const unit = ingredient ? ingredient.unit : '';
        return `
          <tr>
            <td class="border p-2">${r.name}</td>
            <td class="border p-2">${r.qty} √ó ${unit}</td>
            <td class="border p-2 text-right">$${r.cost.toFixed(2)}</td>
            <td class="border p-2 text-center">
              <button onclick="removeRecipeItem(${index})" class="text-red-500 hover:text-red-700">üóëÔ∏è</button>
            </td>
          </tr>
        `;
      }).join('');
      updateTotalCost();
    }

    function updateTotalCost() {
      const total = currentCake.recipe.reduce((sum, i) => sum + i.cost, 0);
      document.getElementById('totalCost').textContent = total.toFixed(2);
    }

    function saveAndReturn() {
      saveCake();
      window.location.href = 'index.html';
    }

    window.addEventListener('DOMContentLoaded', () => {
      updateIngredientDropdown();
      renderIngredientTable();
      renderRecipeTable();
    });
  </script>
</body>
</html>
